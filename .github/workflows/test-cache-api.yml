name: Test Cache API

on:
  workflow_dispatch:  # Execu√ß√£o manual apenas

jobs:
  test-cache-api:
    runs-on: ubuntu-latest
    
    steps:
    - name: Testar API de limpeza de cache
      run: |
        if [ "${{ secrets.PRODUCTION_SITE_URL }}" != "" ]; then
          echo "üß™ Testando API: ${{ secrets.PRODUCTION_SITE_URL }}/api/clear-cache"
          
          # Testa se a API est√° online
          echo "1. Testando se API responde..."
          status_code=$(curl -s -o /dev/null -w "%{http_code}" "${{ secrets.PRODUCTION_SITE_URL }}/api/clear-cache" \
            -X POST \
            -H "Content-Type: application/json" \
            -d '{"all": true}' \
            --max-time 10)
          
          echo "Status Code: $status_code"
          
          if [ "$status_code" = "200" ]; then
            echo "‚úÖ API est√° online e respondendo"
            
            # Testa resposta completa
            echo "2. Testando resposta completa..."
            response=$(curl -s -X POST "${{ secrets.PRODUCTION_SITE_URL }}/api/clear-cache" \
              -H "Content-Type: application/json" \
              -d '{"all": true}')
            
            echo "Resposta: $response"
            
            if echo "$response" | grep -q '"success":true'; then
              echo "‚úÖ API funcionando corretamente"
            else
              echo "‚ùå API respondeu mas com erro"
            fi
          else
            echo "‚ùå API n√£o est√° respondendo (HTTP $status_code)"
            echo "Poss√≠veis causas:"
            echo "- Site ainda n√£o fez deploy"
            echo "- API tem algum erro"
            echo "- URL est√° incorreta"
          fi
        else
          echo "‚ùå PRODUCTION_SITE_URL n√£o configurado"
        fi